将个人的操作行为记录到数据库, 后期做大数据分析

在此RabbitMQ功能: 解耦, 异步

##### 01 定义Log类
```java

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Log {
    /**
     * id
     */
    private Long id;
    /**
     * 用户id
     */
    private Long userId;
    /**
     * 操作时间
     */
    private String logTime;

    /**
     * 操作类型,
     * 0101为登录，0102为注册，
     * 0201为发动态，0202为浏览动态，0203为动态点赞，0204为动态喜欢，0205为评论，0206为动态取消点赞，0207为动态取消喜欢，
     * 0301为发小视频，0302为小视频点赞，0303为小视频取消点赞，0304为小视频评论
     */
    private String type;

    /**
     * 登陆地点
     */
    private String place;
    /**
     * 登陆设备
     */
    private String equipment;

    public Log(Long userId, String logTime, String type) {
        this.userId = userId;
        this.logTime = logTime;
        this.type = type;
    }
}
```


##### 02 LogServer
```java

import com.alibaba.fastjson.JSON;
import org.springframework.amqp.AmqpException;
import org.springframework.amqp.core.AmqpTemplate;
import org.springframework.beans.factory.annotation.Autowired;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

/**
 * 消息发送工具类
 * @author SaddyFire
 * @date 2022/1/5
 * @TIME:15:31
 */
public class MqMessageService {
    @Autowired
    private AmqpTemplate amqpTemplate;

    /**
     * 发送日志消息
     * @param userId 用户id
     * @param type  操作类型,
     * @param key   用户相关user , 动态相关movement , 小视频相关 video
     * @param busId 业务id  动态id或者视频id
     */
    public void sendLogMessage(Long userId,String type,String key, String busId){
        try {
            Map map = new HashMap();
            map.put("userId",userId.toString());
            map.put("type",type);
            map.put("logTime", new SimpleDateFormat("yyyy-MM-dd").format(new Date()));
            map.put("busId",busId);
            String message = JSON.toJSONString(map);
            //发送消息 exchange, routingKey, message
            amqpTemplate.convertAndSend("tanhua.log.exchange","log."+ key,message);
        } catch (AmqpException e) {
            e.printStackTrace();
        }

    }
    
}
```


##### 03 LogListener
```java
import com.alibaba.fastjson.JSON;
import com.tanhua.admin.mapper.LogMapper;
import com.tanhua.model.domain.Log;
import org.springframework.amqp.core.ExchangeTypes;
import org.springframework.amqp.rabbit.annotation.Exchange;
import org.springframework.amqp.rabbit.annotation.Queue;
import org.springframework.amqp.rabbit.annotation.QueueBinding;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.Map;

/**
 * @author SaddyFire
 * @date 2022/1/5
 * @TIME:19:01
 */
public class LogListener {

    @Autowired
    private LogMapper logMapper;

    //添加注解
    @RabbitListener(bindings = @QueueBinding(   //队列绑定
            value = @Queue(value = "tanhua.log.queue", durable = "true"),	//队列名可任意
            exchange = @Exchange(value = "tanhua.log.exchange", type = ExchangeTypes.TOPIC),    //与交换机名字对应
            key = {"log.*"} //监听一切log. 下的message
            )
    )
    //message 来监听 topic
    public void listenCreate(String message){
        Map map = JSON.parseObject(message, Map.class);
        //拿取信息
        Long userId = (Long) map.get("userId");
        String type = (String) map.get("type");
        String logTime = (String) map.get("logTime");
        String busId = (String) map.get("busId");

        Log log = new Log(userId, logTime, type);
        //存入数据库
        logMapper.insert(log);

    }

}
```













